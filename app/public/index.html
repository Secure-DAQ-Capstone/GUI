<!DOCTYPE html>
<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="app.css" /> 
  <title>Poseidon Shield</title>

  <script type="module">
    // Load data from the backend API
  async function loadData(ids) { 
    try {
      if(ids){
        //Format ids to be used in the URL to be in this format /data?id=1&id=2&id=3
        ids = ids.split(',').map(id => `id=${id}`).join('&');

        // Fetch data from the backend API
        let response = await fetch(`/data?${ids}`);

        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.statusText}`);
        }

        //Print the response
        console.log(response);

        // Parse the JSON response
        let tasks = await response.json();

        // Dynamically create cards for each data
        tasks.forEach((task) => card_maker(task));
      }
      else{
        // Fetch data from the backend API
        let response = await fetch('/data');

        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.statusText}`);
        }

        // Parse the JSON response
        let tasks = await response.json();

        // Dynamically create cards for each data
        tasks.forEach((task) => card_maker(task));
      }
    } 
    catch (error) {
      console.error('Error loading data:', error);
      alert('Failed to load data. Please try again later.');
    }
  }

  //Funtion to create a new card element using the template
  function card_maker(card_info){
    // Get the card template
    let template = document.getElementById("cardTemplate");
    let cardClone = template.content.cloneNode(true);

    let cardDiv = cardClone.querySelector('.listViewCard');
    cardDiv.setAttribute('id', `card-${card_info._id}`);

    // Create a container for the paragraphs
    let fieldContainer = document.createElement("div");
    fieldContainer.classList.add("field-container");
    
    //Loop through the card_info and create paragraphs for each key value pair
    for (let key in card_info) {
      if (key === "_id") {
        continue;
      }
      let p = document.createElement("p");
      p.textContent = `${key}: ${card_info[key]}`;
      fieldContainer.appendChild(p);
    }

    cardDiv.appendChild(fieldContainer);

    // Append the card to the list view container
    let listViewContainer = document.querySelector('.listview-container');
    listViewContainer.appendChild(cardClone);

    // Add event listener to the card
    cardDiv.addEventListener("click", () => {
      window.location.href = `card-details.html?id=${card_info._id}`;
    });
  }

  document.addEventListener("DOMContentLoaded", async () => {
    //Get the URL parameters
    let urlParams = new URLSearchParams(window.location.search);
    let ids = urlParams.get('ids');

    // Load data from the backend API
    await loadData(ids);
  });
</script>

<!-- Card template -->
<template id="cardTemplate">
  <div class="listViewCard">
  </div>
</template>

</head>
<body>
<div class="app">
  <div class="navbar">
    Poseidon Shield
  </div>
  <div class="list">
    <div class="listview-container">
    </div>
  </div>
</div>
</body>
</html>