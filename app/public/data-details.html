<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" type="text/css" href="app.css" />
  <title>Data Details</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function loadData(cardId) {
      try {
        let response = await fetch(`/data?id=${cardId}`);
        if (!response.ok) throw new Error(`Failed to fetch data: ${response.statusText}`);
        return await response.json();
      } catch (error) {
        console.error('Error loading data:', error);
        alert('Failed to load data. Please try again later.');
      }
    }

    function createTimeline(relayChain) {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '<div class="timeline-connector"></div>';
      
      relayChain.forEach((step, index) => {
        const stepElement = document.createElement('div');
        stepElement.className = 'timeline-step';
        stepElement.innerHTML = `
          <div class="timeline-circle"></div>
          <div>Board ${step.boardId}</div>
          <div>${new Date(step.timestamp * 1000).toLocaleTimeString()}</div>
        `;
        timeline.appendChild(stepElement);
      });
    }

    window.addEventListener("load", async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const dataId = urlParams.get("id");
      const data = await loadData(dataId);
      console.log(data);

      if (data) {
        // Populate basic fields using divs
        document.getElementById('sensor-type').textContent = data[0].label;
        document.getElementById('sensor-value').textContent = data[0].dataValue.split(": ")[1];
        document.getElementById('timestamp').textContent = 
          new Date(data[0].timeDataCaptured).toLocaleString();
        document.getElementById('origin-board').textContent = data[0].boardIdMsgOrigin;
        document.getElementById('digital-signature').textContent = data[0].digitalSignature;

        // Create timeline visualization
        createTimeline(data[0].relayChain);

        // Add relay chain validation warning
        const isValid = data[0].relayChainVerification;
        if (!isValid) {
          const warningDiv = document.createElement('div');
          warningDiv.className = 'warning-section';
          warningDiv.innerHTML = `
            <h2>⚠️ Time Sequence Warning</h2>
            <div>Relay chain timestamps are not in chronological order. 
            This indicates a potential issue with the data transmission timing or data tampering.</div>
          `;
          document.getElementById('details-form').appendChild(warningDiv);
        }
      } else {
        alert("Data entry not found");
        window.location.href = "index.html";
      }
    });

    function returnHome() {
      window.location.href = "index.html";
    }
  </script>
</head>
<body>
  <div class="app">
    <div class="navbar">
      Data Details
      <button type="button" id="home" onclick="returnHome()">Home</button>
    </div>
    <div class="data-container">
      <div id="details-form">
        <!-- Static Fields -->
        <div class="data-field">
          <label class="data-label">Sensor Type:</label>
          <div id="sensor-type" class="data-value"></div>
        </div>
        <div class="data-field">
          <label class="data-label">Value:</label>
          <div id="sensor-value" class="data-value"></div>
        </div>
        <div class="data-field">
          <label class="data-label">Timestamp:</label>
          <div id="timestamp" class="data-value"></div>
        </div>
        <div class="data-field">
          <label class="data-label">Origin Board ID:</label>
          <div id="origin-board" class="data-value"></div>
        </div>

        <!-- Digital Signature -->
        <div class="data-field">
          <label class="data-label">Digital Signature:</label>
          <div id="digital-signature" class="data-value"></div>
        </div>

        <!-- Relay Chain Visualization -->
        <div class="data-field">
          <label class="data-label">Data Transmission Path:</label>
          <div class="timeline" id="timeline"></div>
        </div>
      </div>
  </div>
</body>
</html>